#!/bin/bash
# original code by krinkle (cmurphy) edited by dom as a fork
mkfifo .botfile
export foodfile="foods.txt"
export chan=$1
if [ "$2" != '' ] && [ -f "$2" ] ; then
  export key=`cat $2`
fi
export pgkey=$3

# function to read in from text file liny by line. Outputs to channel.
readfoods(){
    





}


tail -f .botfile | openssl s_client -connect irc.cat.pdx.edu:6697 | while true; do
  if [[ -z $started ]] ; then
    # give irc the necessary information needed for a user
    echo "USER needabotbot needabotbot needabotbot :needabotbot" >> .botfile
    echo "NICK needabotbot" >> .botfile
    echo "JOIN #$chan $key" >> .botfile
    started="yes"
  fi
  
  read irc
  echo $irc
  # trigger to pong when irc sends ping
  if `echo $irc | cut -d ' ' -f 1 | grep PING > /dev/null`; then
    echo "PONG" >> .botfile 
  elif `echo $irc | grep PRIVMSG | grep 'need a bot\b' > /dev/null` ; then
    
    # trigger to reply with "you could write it..." when seeing "need a bot" in irc
    nick="${irc%%!*}"; nick="${nick#:}"
    if [[ $nick != 'needabotbot' ]] ; then
      echo "PRIVMSG #$chan :you could write it..." >> .botfile
    fi
  elif `echo $irc | grep PRIVMSG | grep 'bot needs to\b' > /dev/null` ; then

   # trigger to reply with "submit a pull request!" when seeing "bot needs to" in irc
   nick="${irc%%!*}"; nick="${nick#:}"
   echo "PRIVMSG #$chan :submit a pull request!" >> .botfile

  elif `echo $irc | grep PRIVMSG | grep 'bot should\b' > /dev/null` ; then
  
    # trigger to reply with "make an issue!" when seeing "bot should" in irc
    nick="${irc%%!*}"; nick="${nick#:}"
    echo "PRIVMSG #$chan :make an issue!" >> .botfile


  elif `echo $irc | grep PRIVMSG | grep 'nabb:'| grep 'open\b' > /dev/null` ; then
        
        # trigger to read from file when when pinged and seeing "open" in message
        nick="${irc%%!*}"; nick="${nick#:}"
        readfoods

  elif `echo $irc | grep PRIVMSG | grep 'needabotbot:'| grep 'open' > /dev/null` ; then
        
        # tab-complete functionality for above elif block
        nick="${irc%%!*}"; nick="${nick#:}"
        
        
        
        
        readfoods

      
  fi       
 
done



